#!/usr/bin/env bash
# NASA APOD Wallpaper Fetcher
# Place at: ~/.local/bin/nasa-wallpaper
# Make executable: chmod +x ~/.local/bin/nasa-wallpaper
#
# Fetches NASA's Astronomy Picture of the Day and sets it as wallpaper
# Uses swww for smooth transitions
#
# Dependencies: curl, jq, swww
#
# Usage:
#   nasa-wallpaper              # Fetch today's APOD
#   nasa-wallpaper random       # Fetch a random APOD from the last 30 days
#   nasa-wallpaper loop         # Fetch new + cycle through local wallpapers every 10 min
#   nasa-wallpaper local        # Cycle through already downloaded wallpapers (no fetch)
#   nasa-wallpaper count        # Show number of saved wallpapers

WALLPAPER_DIR="$HOME/.local/share/wallpapers/nasa"
CACHE_FILE="$WALLPAPER_DIR/.apod_cache"
NASA_API="https://api.nasa.gov/planetary/apod"
# NOTE: DEMO_KEY has low rate limits (30/hour). Get a free key at https://api.nasa.gov/
# Store your key in ~/.config/nasa-apod-key or set NASA_API_KEY environment variable
API_KEY="${NASA_API_KEY:-$(cat ~/.config/nasa-apod-key 2>/dev/null || echo "DEMO_KEY")}"
LOOP_INTERVAL=600   # 10 minutes

# Create wallpaper directory (owner-only permissions)
mkdir -p -m 700 "$WALLPAPER_DIR"

# Ensure swww daemon is running
if ! pgrep -x "swww-daemon" > /dev/null; then
    swww-daemon &
    sleep 1
fi

fetch_apod() {
    local date_param=""
    if [[ "$1" == "random" ]]; then
        # Random date in the last 365 days for more variety
        local days_ago=$((RANDOM % 365))
        local random_date=$(date -d "$days_ago days ago" +%Y-%m-%d)
        date_param="&date=$random_date"
    fi

    # Fetch APOD metadata
    local response=$(curl -s "${NASA_API}?api_key=${API_KEY}${date_param}")

    # Check if it's an image (not a video)
    local media_type=$(echo "$response" | jq -r '.media_type')
    if [[ "$media_type" != "image" ]]; then
        echo "Today's APOD is a video, fetching a different day..."
        fetch_apod "random"
        return
    fi

    # Get HD image URL (fallback to regular if no HD)
    local image_url=$(echo "$response" | jq -r '.hdurl // .url')
    local title=$(echo "$response" | jq -r '.title')
    local date=$(echo "$response" | jq -r '.date')

    if [[ -z "$image_url" || "$image_url" == "null" ]]; then
        echo "Failed to get image URL"
        return 1
    fi

    # Download image
    local filename="$WALLPAPER_DIR/apod_${date}.jpg"

    if [[ ! -f "$filename" ]]; then
        echo "Downloading: $title ($date)"
        curl -s -o "$filename" "$image_url"
    else
        echo "Using cached: $title ($date)"
    fi

    set_wallpaper "$filename"

    # Send notification
    notify-send "NASA APOD" "$title" -i "$filename" 2>/dev/null || true

    echo "Wallpaper set: $title"
}

set_wallpaper() {
    local filename="$1"

    # Set wallpaper with swww (smooth transition)
    swww img "$filename" \
        --transition-type grow \
        --transition-pos "0.9,0.1" \
        --transition-duration 2 \
        --transition-fps 60

    # Save current wallpaper info
    echo "$filename" > "$CACHE_FILE"
}

set_random_local() {
    local wallpapers=("$WALLPAPER_DIR"/apod_*.jpg)
    if [[ ${#wallpapers[@]} -eq 0 || ! -f "${wallpapers[0]}" ]]; then
        echo "No local wallpapers found, fetching new one..."
        fetch_apod "random"
        return
    fi

    local random_wallpaper="${wallpapers[RANDOM % ${#wallpapers[@]}]}"
    local basename=$(basename "$random_wallpaper" .jpg)
    local date="${basename#apod_}"

    set_wallpaper "$random_wallpaper"
    echo "Wallpaper set: $date (from local cache)"
}

loop_mode() {
    echo "Starting wallpaper rotation (every 10 minutes)..."
    echo "Fetching new wallpaper first, then cycling through local collection..."

    # Fetch a new one first
    fetch_apod "random"

    while true; do
        sleep $LOOP_INTERVAL
        set_random_local
    done
}

local_loop_mode() {
    echo "Starting local wallpaper rotation (every 10 minutes)..."
    while true; do
        set_random_local
        sleep $LOOP_INTERVAL
    done
}

count_wallpapers() {
    local count=$(ls -1 "$WALLPAPER_DIR"/apod_*.jpg 2>/dev/null | wc -l)
    echo "NASA APOD wallpapers saved: $count"
    echo "Location: $WALLPAPER_DIR"
}

case "${1:-}" in
    random)
        fetch_apod "random"
        ;;
    loop)
        loop_mode
        ;;
    local)
        local_loop_mode
        ;;
    count)
        count_wallpapers
        ;;
    *)
        fetch_apod
        ;;
esac
