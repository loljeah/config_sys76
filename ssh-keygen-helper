#!/usr/bin/env bash
# ssh-keygen-helper - Generate and manage SSH keys by trust domain
# Usage: ssh-keygen-helper [personal|work|git|custom NAME]

set -euo pipefail

SSH_DIR="$HOME/.ssh"
HOSTNAME=$(hostname)

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info()  { printf "${CYAN}[*]${NC} %s\n" "$*"; }
ok()    { printf "${GREEN}[+]${NC} %s\n" "$*"; }
warn()  { printf "${YELLOW}[!]${NC} %s\n" "$*"; }

show_usage() {
    cat << 'EOF'
SSH Key Generator - Trust Domain Based

Usage: ssh-keygen-helper <domain>

Domains:
  personal    Personal servers, homelab, side projects
  work        Work infrastructure, production servers
  git         GitHub, GitLab, Bitbucket
  custom      Create a custom-named key

Examples:
  ssh-keygen-helper personal
  ssh-keygen-helper work
  ssh-keygen-helper git
  ssh-keygen-helper custom client-projectname

After generating keys:
  1. Add public key to servers: ssh-copy-id -i ~/.ssh/KEY.pub user@server
  2. Update ~/.ssh/config to map hosts to keys
  3. Add key name to SSH_KEYS in ~/.bashrc for keychain

EOF
    exit 0
}

generate_key() {
    local name="$1"
    local comment="$2"
    local keyfile="$SSH_DIR/id_ed25519_$name"

    if [[ -f "$keyfile" ]]; then
        warn "Key already exists: $keyfile"
        read -p "Overwrite? [y/N] " -n 1 -r
        echo
        [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
    fi

    mkdir -p "$SSH_DIR"
    chmod 700 "$SSH_DIR"

    info "Generating ed25519 key: $keyfile"
    echo ""

    # Generate key with passphrase prompt
    ssh-keygen -t ed25519 -f "$keyfile" -C "$comment"

    # Set permissions
    chmod 600 "$keyfile"
    chmod 644 "$keyfile.pub"

    echo ""
    ok "Key generated successfully!"
    echo ""
    info "Private key: $keyfile"
    info "Public key:  $keyfile.pub"
    echo ""
    info "Public key contents (copy to servers):"
    echo ""
    cat "$keyfile.pub"
    echo ""

    # Remind about keychain
    warn "Add '${name}' to SSH_KEYS in ~/.bashrc:"
    echo "    SSH_KEYS=\"id_ed25519_$name\""
    echo ""
    warn "Or for multiple keys:"
    echo "    SSH_KEYS=\"id_ed25519_personal id_ed25519_work id_ed25519_git\""
}

list_keys() {
    info "Existing SSH keys in $SSH_DIR:"
    echo ""

    if ls "$SSH_DIR"/id_* 2>/dev/null | grep -v '\.pub$' > /dev/null; then
        for key in "$SSH_DIR"/id_*; do
            [[ "$key" == *.pub ]] && continue
            local keyname=$(basename "$key")
            local fingerprint=$(ssh-keygen -lf "$key" 2>/dev/null | awk '{print $2}')
            local comment=$(ssh-keygen -lf "$key" 2>/dev/null | awk '{print $3}')
            printf "  %-30s %s (%s)\n" "$keyname" "$fingerprint" "$comment"
        done
    else
        echo "  (no keys found)"
    fi
    echo ""
}

case "${1:-help}" in
    personal)
        generate_key "personal" "personal@$HOSTNAME"
        ;;
    work)
        generate_key "work" "work@$HOSTNAME"
        ;;
    git)
        generate_key "git" "git@$HOSTNAME"
        ;;
    custom)
        if [[ -z "${2:-}" ]]; then
            warn "Usage: ssh-keygen-helper custom NAME"
            exit 1
        fi
        generate_key "$2" "$2@$HOSTNAME"
        ;;
    list)
        list_keys
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        warn "Unknown domain: $1"
        show_usage
        ;;
esac
